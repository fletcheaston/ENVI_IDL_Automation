# Complete!

# Opens the .hsi and _igm file as a raster.
dataRaster = E.OpenRaster({hsiFile})
locationRaster = E.OpenRaster({igmFile})

# FID are file identifiers, used by IDL so we can easily reference the file later.
dataFID = ENVIRastertoFID(dataRaster)
locationFID = ENVIRastertoFID(locationRaster)

# Look into more later.
inputProjection = ENVI_PROJ_CREATE(/geographic)

# ENVI_FILE_QUERY looks at a file, specified by the FID, and returns a number of characteristics about the file.
# We're mainly looking at raster files, and we want the dimensions of the raster.
ENVI_FILE_QUERY, locationFID, DIMS=locationDims

# Builds the GLT file. The important parts are the ROTATION, X_POS, and Y_POS.
# X_POS and Y_POS refer to bands in the locationRaster file. The X_POS is Band 2, and Y_POS is Band 1, but IDL starts counting bands at 0.
ENVI_DOIT, 'ENVI_GLT_DOIT', DIMS=locationDims, I_PROJ=inputProjection, O_PROJ=inputProjection, R_FID=gltFID, OUT_NAME=tempGltFile, X_FID=locationFID, Y_FID=locationFID, X_POS=1, Y_POS=0

# More file querying. We have to get the dimensions again, as they've changed.
# Dimensions have changed because of the rotation we specified when building the GLT file.
ENVI_FILE_QUERY, gltFID, DIMS=gltDims

# The real meat of the processing. Georeferences all the bands to the glt file we just build.
# The important  parts are the OUT_NAME, R_FID, and POS.
# OUT_NAME and R_FID must be unique.
# R_FID, which is the returned FID of the new file, is needed in task two for the band math.
# POS refers to what bands from the dataRaster we want to use. We'll use all 150 of them for now.
# And no, there isn't a shorter way to specify all the bands, you really do have to put every number 0 to 149.
ENVI_DOIT, 'ENVI_GEOREF_FROM_GLT_DOIT', BACKGROUND=0, FID=dataFID, GLT_DIMS=gltDims, GLT_FID=gltFID, OUT_NAME={refGltFile}, POS=[0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17,18,19,20,21,22,23,24,25,26,27,28,29,30,31,32,33,34,35,36,37,38,39,40,41,42,43,44,45,46,47,48,49,50,51,52,53,54,55,56,57,58,59,60,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,81,82,83,84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118,119,120,121,122,123,124,125,126,127,128,129,130,131,132,133,134,135,136,137,138,139,140,141,142,143,144,145,146,147,148,149], R_FID={refGltFID}

# Save all the georeferenced files to the filesystem.
tempOutputRaster = ENVIFIDToRaster({refGltFID})
tempOutputRaster.Export, E.GetTemporaryFilename(), 'TIFF'
